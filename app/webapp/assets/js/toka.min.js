"use strict";function timestamp(t){return"undefined"==typeof t?moment().format("MMM D, YYYY h:mma"):(t=moment.utc(t,"MMM D, YYYY h:mma"),moment(t.toDate()).format("MMM D, YYYY h:mma"))}function timediff(){time=moment.utc(time,"MMM D, YYYY h:mma");var t=moment.utc(moment().utc().format("MMM D, YYYY h:mm a"),"MMM D, YYYY h:mma"),o=moment.duration(t.diff(time)).asHours(),e=moment.duration(t.diff(time)).asMinutes(),a=moment.duration(t.diff(time)).asSeconds();return o>6?moment(time.toDate()).format("MMM D, YYYY h:mma"):o>1?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(o,10)+" hours ago":1==o?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(o,10)+" hour ago":e>1?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(e,10)+" minutes ago":1==e?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(e,10)+" minute ago":moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(a,10)+" seconds ago"}function createrandomid(t){for(var o="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_",a=0;t>a;a++)o+=e.charAt(Math.floor(Math.random()*e.length));return o}function Autocomplete(t,o){this.container=t,this.input=o,this.app,this.active=!1,this.startIndex=-1}function CommandHelp(t,o){this.container=t,this.input=o,this.app,this.active,this.autocomplete=!0,this.commands={"/define":{options:"[word]",desc:"Define a word"},"/me":{options:"[text]",desc:"Perform an action"},"/spoiler":{options:"[text]",desc:"Hide text in a spoiler block"},"/urban":{options:"[word]",desc:"Find the urban dictionary definition of a word"},"/view":{options:"[room]",desc:"Peek into a room by providing a chatroom id"}}}function Log4n(){this.info=function(t){console&&console.log("[INFO] "+new Date+" - "+t)},this.warn=function(t){console&&console.warn("[WARN] "+new Date+" - "+t)},this.error=function(t){console&&console.error("[ERROR] "+new Date+" - "+t),console.trace()}}function ChatroomApp(){this.cloudinaryTimestamp,this.ini=function(t){var o=this,t=new Chatroom(t);t.iniChatroom(),toka.currentChatroom=t,toka.chatrooms[t.chatroomId]=t,toka.tokabot.options.focused=!0,$(window).focus(function(){toka.tokabot.options.focused=!0}).blur(function(){toka.tokabot.options.focused=!1}),$("#chatroom-title-update-chatroom div[data-toggle='tooltip']").tooltip({placement:"bottom"}),toka.hasUserSession()&&o.cloudinary(),o.connect()},this.connect=function(){try{toka.socket=io.connect(toka.chata,{secure:!0}),toka.socket.on("connect",function(){console.log("Connection opened."),$(".chatroom .input-msg").attr("placeholder","Connected. Retrieving history..."),toka.socket.emit("join",{chatroomId:toka.currentChatroom.chatroomId,username:toka.getCookie("username")}),toka.socket.emit("users",toka.currentChatroom.chatroomId)}),toka.socket.on("activeViewerCount",function(t){$(".chatroom-heading .users span").text(t[toka.currentChatroom.chatroomId])}),toka.socket.on("users",function(t){var o=toka.currentChatroom.chatroomId;if(t.hasOwnProperty(o)){for(var e=0;e<t[o].length;e++)toka.chatrooms[o].registerNewUserTheme(t[o][e],e);$(".chatroom .user-list ul").empty();for(var e=0;e<t[toka.currentChatroom.chatroomId].length;e++)$(".chatroom .user-list ul").append($("<li></li>",{text:t[toka.currentChatroom.chatroomId][e]}))}}),toka.socket.on("history",function(t){$(".chatroom .input-msg").attr("placeholder","Type here to chat. Use / for commands."),toka.chatrooms.hasOwnProperty(t.chatroomId)&&($(toka.chatrooms[t.chatroomId].selectChatroomList).empty(),toka.chatrooms[t.chatroomId].loadHistory(t))}),toka.socket.on("receiveMessage",function(t){toka.chatrooms.hasOwnProperty(t.chatroomId)&&(toka.chatrooms[t.chatroomId].registerNewUserTheme(t.username),toka.chatrooms[t.chatroomId].receiveMessage(t)),$(toka.currentChatroom.selectChatroomInputMsg).is(":focus")||(toka.newMessages++,toka.setTitle("(1+) Toka"))}),toka.socket.on("disconnect",function(){console.log("Connection closed."),$(".chatroom .input-msg").attr("placeholder","Disconnected. Reconnecting...")})}catch(t){console.log("Could not connect to chata!")}},this.cloudinary=function(){var t=this;t.cloudinaryTimestamp=$(".cloudinary-fileupload").data("form-data").timestamp,$(".upload-img-btn").on("click",function(){t.setPublicId(),$(".cloudinary-fileupload:file").trigger("click")}),$(".cloudinary-fileupload").bind("cloudinarydone",function(t,o){var e=toka.getCookie("username"),a=new Message(toka.currentChatroom.chatroomId,e,"/image "+o.result.public_id+"."+o.result.format,timestamp());toka.tokabot.sendMessage(a)})},this.getNewCloudinarySig=function(){$.ajax({method:"get",url:"/api/cloudinary/key",dataType:"json",success:function(t){$(".cloudinary-fileupload").fileupload({formData:t})}})},this.setPublicId=function(){var t={formData:$(".cloudinary-fileupload").data("form-data")};t.formData.public_id="user/"+toka.getCookie("username")+"/"+createrandomid(12),$(".cloudinary-fileupload").fileupload(t)}}function Chatroom(t){this.newMessages=0,this.lastSender="",this.autoScroll=!0;for(var o in t)this[o]=t[o];this.groupMessageFlag="n",this.colorThemes=["FF8D36","3396FF","009688","FFB300","FF5E5E","ED72D7","A378FF","607D8B","8BC34A","1FC435","673AB7"],this.userTheme={},this.themeIndex=Math.floor(Math.random()*this.colorThemes.length),this.selectChatroom=".chatroom[data-chatroom-id='"+this.chatroomId+"']",this.selectChatroomList=this.selectChatroom+" .messages",this.selectChatroomBody=this.selectChatroom+" .messages-container",this.selectChatroomChatBox=this.selectChatroom+" .chatbox",this.selectChatroomInfoBox=this.selectChatroom+" .infobox",this.selectChatroomInputMsg=this.selectChatroom+" .inputbox .input-msg",this.selectChatroomTitleMenuUser=this.selectChatroom+" .title-menu .users",this.selectChatroomUserList=this.selectChatroom+" .user-list",this.commandHelp=new CommandHelp($(this.selectChatroomChatBox),$(this.selectChatroomInputMsg))}function Message(t,o,e,a){this.chatroomId=t,this.username=o,this.text=e,this.timestamp=a}function LeftNavApp(){this.ini=function(){$("#profile").on("click",function(){$("#profile-menu").hasClass("open")?($("#profile-menu").slideUp(500),$("#profile-menu").removeClass("open").addClass("closed")):($("#profile-menu").slideDown(500),$("#profile-menu").removeClass("closed").addClass("open"))}),$("#chatfeed-btn").off("click").on("click",function(){var t=$("#chatfeed iframe").attr("src");"about:blank"==t&&$("#chatfeed iframe").attr("src","/chatroom/"+toka.getCookie("username")+"?embed=1&target=_blank"),$("#chatfeed").modal("show")})}}function TopNavApp(){this.ini=function(){$("#toka-left-nav-toggle").on("click",function(){if($("#site-left-nav").hasClass("closed")){var t=Number($("#site-content").css("width").replace("px",""))-220;$("#site-left-nav").toggle("slide","left",800),$("#site-content").effect("size",{to:{"margin-left":"220px",width:t+"px"}},800),$("#site-left-nav").removeClass("closed").addClass("open")}else{var t=Number($("#site-content").css("width").replace("px",""))+220;$("#site-left-nav").toggle("slide","right",800),$("#site-content").effect("size",{to:{"margin-left":"0px",width:t+"px"}},800),$("#site-left-nav").removeClass("open").addClass("closed")}}),$("#chatfeed-btn").off("click").on("click",function(){var t=$("#chatfeed iframe").attr("src");"about:blank"==t&&$("#chatfeed iframe").attr("src","/chatroom/"+toka.getCookie("username")+"?embed=1&target=_blank"),$("#chatfeed").modal("show")})}}$.fn.sorted=function(t){var o={reversed:!1,by:function(t){return t.text()}};$.extend(o,t);var e=$(this),a=e.get();return a.sort(function(t,e){var a=o.by($(t)),s=o.by($(e));return o.reversed?s>a?1:a>s?-1:0:s>a?-1:a>s?1:0}),$(a)};var log=new Log4n;Autocomplete.prototype.ini=function(){var t=this;t.input.on("input",function(o){var e=t.input.val(),a=e.substr(e.length-1,e.length);if(console.log("User typed: "+a),"@"===a)t.active=!0;else if(t.active){-1==t.startIndex&&(t.startIndex=e.length-1);var s=e.substr(t.startIndex);t.getUsernameMatches(s)}})},Autocomplete.prototype.getUsernameMatches=function(t){var o=this;o.app=$("<div></div>",{"class":"autocomplete-username",style:"display: none;"}).append($("<div></div>",{"class":"title",html:'<span>usernames matching:</span><span class="text"></span>'})).append($("<ul></ul>",{"class":"ac-username-list"})),o.container.append(o.app);var e={};$.ajax({url:"/rs/user/search?u="+t,type:"GET",dataType:"json",beforeSend:e.hasOwnProperty("beforeSend")?e.beforeSend:function(){},complete:e.hasOwnProperty("complete")?e.complete:function(){},success:function(t){200!==t.status?console.log("Error!!"):o.app.show()}})},CommandHelp.prototype.ini=function(){var t=this;t.app=$("<div></div>",{"class":"commands-help",style:"display: none;"}).append($("<div></div>",{"class":"commands-top",html:"<span>Commands</span>"})).append($("<ul></ul>",{"class":"commands-list"})),t.container.append(t.app);for(var o in t.commands)t.commands.hasOwnProperty(o)&&t.app.find(".commands-list").append($("<li></li>",{html:'<span class="command">'+o+' </span><span class="command-options">'+t.commands[o].options+'</span><span class="command-desc">'+t.commands[o].desc+"</span>"}));t.app.find(".commands-list li:first").addClass("selected"),$("html").on("keyup",function(o){return t.active&&27==o.which?void t.hide():void 0}),t.app.find("li").on("click",function(){var o=t.app.find("li.selected");o.removeClass("selected"),$(this).addClass("selected");var e=$(this).find(".command").text();t.filterList(e),t.loadCommand($(this))}),t.input.on("input",function(o){var e=t.input.val();"/"===e?(t.app.show(),t.active=!0,$(t.input).addClass("commandActive"),$(t.app).css("bottom",$(t.input).outerHeight())):""==e&&t.hide()}),t.input.on("keyup",function(o){var e=t.input.val(),a=e.split(" ")[0];if(t.active){if(t.active&&38==o.which){var s=t.app.find("li.selected");return void(s.prev().length&&(s.removeClass("selected"),s.prev().addClass("selected")))}if(40==o.which){var s=t.app.find("li.selected");return void(s.next().length&&(s.removeClass("selected"),s.next().addClass("selected")))}if(13==o.which&&!o.shiftKey||9==o.which){var s=t.app.find("li.visible.selected"),n=s.find(".command").text();return void(n.length>=e.length?t.loadCommand(s):t.hide())}t.filterList(a);var s=t.app.find("li.visible:first").addClass("selected");0==s.length?t.autocomplete=!1:t.autocomplete=!0}})},CommandHelp.prototype.filterList=function(t){var o=this;o.app.find("li").filter(function(){$(this).show(),$(this).addClass("visible"),$(this).removeClass("selected");var o=$(this).text();o.indexOf(t)<0&&($(this).hide(),$(this).removeClass("visible"))})},CommandHelp.prototype.hide=function(){var t=this;$(t.app).hide(),t.active=!1,$(t.input).removeClass("commandActive")},CommandHelp.prototype.loadCommand=function(t){var o=this,e=t.find(".command").text();o.input.val(e),o.input.focus()},CommandHelp.prototype.sendReady=function(){var t=this;return!t.active||t.active&&!t.autocomplete},Chatroom.prototype.iniChatroom=function(){var t=this;$(t.selectChatroomBody).height(t.getHeight()),$(window).on("resize",function(){$(t.selectChatroomBody).height(t.getHeight())}),$(window).on("focus",function(){toka.newMessages=0,toka.setTitle(t.chatroomName+" - Toka")}),$(t.selectChatroomInputMsg).off("click").on("click",function(){toka.newMessages=0,toka.setTitle(t.chatroomName+" - Toka")}),$(t.selectChatroomInputMsg).on("keydown",function(t){(9==t.which||13==t.which&&!t.shiftKey)&&t.preventDefault()}),t.commandHelp.ini(),$(t.selectChatroomInputMsg).on("keyup",function(o){toka.newMessages=0,toka.setTitle(t.chatroomName+" - Toka"),t.commandHelp.sendReady()&&13===o.which&&(o.shiftKey||t.sendMessage())}),$(t.selectChatroomTitleMenuUser).off().on({mouseenter:function(){toka.socket.emit("users",toka.currentChatroom.chatroomId);var o=$(this).offset(),e=$(t.selectChatroomUserList);e.width("auto");var a=e.width();e.width(a),e.show().offset({top:o.top,left:o.left-a})},mouseleave:function(){$(t.selectChatroomUserList).hide()}}),$(t.selectChatroomBody).mCustomScrollbar({theme:"dark",alwaysShowScrollbar:1,mouseWheelPixels:550,callbacks:{whileScrolling:function(){t.autoScroll=!1,this.mcs.topPct>=99.5&&(t.autoScroll=!0)}}}),$(t.selectChatroomInfoBox).mCustomScrollbar({alwaysShowScrollbar:0,mouseWheel:{scrollAmount:120}})},Chatroom.prototype.getHeight=function(){return $("#site").height()-$("#site-menu").height()-$(".chatroom-heading").outerHeight(!0)-$(".inputbox").outerHeight()},Chatroom.prototype.getColorTheme=function(t){return this.colorThemes[t%this.colorThemes.length]},Chatroom.prototype.loadHistory=function(t){toka.tokabot.loadHistory(t)},Chatroom.prototype.receiveMessage=function(t){var o=this;$(o.selectChatroomList),toka.getCookie("username");t.timestamp=timestamp(t.timestamp),toka.tokabot.receiveMessage(t)},Chatroom.prototype.registerNewUserTheme=function(t){var o=this;o.userTheme.hasOwnProperty(t)||(o.userTheme[t]=o.getColorTheme(this.themeIndex),o.themeIndex++)},Chatroom.prototype.scrollChatToBottom=function(){var t=this;$(t.selectChatroomBody).mCustomScrollbar("update"),$(t.selectChatroomBody).mCustomScrollbar("scrollTo","bottom",{scrollInertia:0})},Chatroom.prototype.sendMessage=function(){var t=this,o=toka.getCookie("username");if(""===o)return void toka.promptLogin();var e=$(t.selectChatroomInputMsg).val(),a=new Message(t.chatroomId,o,e,timestamp());""!==e.trim()&&($(t.selectChatroomInputMsg).val(""),toka.tokabot.sendMessage(a))},Chatroom.prototype.update=function(){var t=this;if(!toka.hasUserSession())return void toka.alert("Cannot update chatroom! Please log in.");var o={};o.chatroomId=t.chatroomId,o.categoryName=t.categoryName,o.chatroomName=t.chatroomName,o.info=t.info,o.tags=t.tags;var e={beforeSend:function(){$("#update-chatroom-loader").show()},complete:function(){$("#update-chatroom-loader").hide()}};$.ajax({url:"/chatroom/"+t.chatroomId+"/update",type:"POST",data:o,dataType:"json",beforeSend:e.hasOwnProperty("beforeSend")?e.beforeSend:function(){},complete:e.hasOwnProperty("complete")?e.complete:function(){},success:function(t){if(200!==t.status){var o=t.message;o=o.charAt(0).toUpperCase()+o.slice(1),chatroomApp.alertUpdateChatroom("Server Error: "+o)}else window.location.href="/chatroom/"+t.chatroomId}})},Chatroom.prototype.updateChatroomItemUsers=function(t){$(".chatroom-item[data-chatroom-id='"+this.chatroomId+"'] .chatroom-item-users-count").text(t)};var toka=new function(){this.atlas,this.chata="https://toka.io:1337",this.socket,this.chatrooms={},this.currentChatroom={},this.newMessages=0,this.sortedChatroomList=!1,this.tokabot;var t=new LeftNavApp,o=new TopNavApp;this.ini=function(){var e=this;e.adjustSiteContentHeight(),$(window).off("resize").on("resize",function(){e.adjustSiteContentHeight()}),t.ini(),o.ini()},this.adjustSiteContentHeight=function(){$("#site-content").css("min-height",$("#site").height()-$("#site-menu").height()),$("#site-content").css("max-height",$("#site").height()-$("#site-menu").height()),$("#site-left-nav").css("min-height",$("#site").height()-$("#site-menu").height())},this.getCookie=function(t){for(var o=t+"=",e=document.cookie.split(";"),a=0;a<e.length;a++){for(var s=e[a];" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(o))return s.substring(o.length,s.length)}return""},this.hasUserSession=function(){return!(""===this.getCookie("username"))},this.promptLogin=function(){$("#login-form").off().on("shown.bs.modal",function(){$("#toka-login-username").focus()}),$("#login-form").modal("show")},this.resetTitle=function(){this.setTitle("Toka")},this.setChatrooms=function(t){var o=this;for(var e in t)o.chatrooms[e]=new Chatroom(t[e])},this.setTitle=function(t){$("title").text(t)}},banned_list={bitch:1,dick:1,fuck:1,motherfucker:1,penis:1,shit:1,vagina:1,wanker:1,god:1,jesus:1,christ:1,satan:1},reserved_list={google:1,facebook:1,linkedin:1,microsoft:1,twitter:1,support:1,tokaadmin:1,toka_admin:1,tokahelp:1,toka_help:1,tokasupport:1,toka_support:1,tokabot:1,toka_bot:1};