"use strict";function Autocomplete(t,e){this.container=t,this.input=e,this.app,this.active=!1,this.startIndex=-1}function CommandHelp(t,e){this.container=t,this.input=e,this.app,this.active,this.autocomplete=!0,this.commands={"/define":{options:"[word]",desc:"Define a word"},"/me":{options:"[text]",desc:"Perform an action"},"/spoiler":{options:"[text]",desc:"Hide text in a spoiler block"},"/urban":{options:"[word]",desc:"Find the urban dictionary definition of a word"},"/view":{options:"[room]",desc:"Peek into a room by providing a chatroom id"}}}function timestamp(t){return"undefined"==typeof t?moment().format("MMM D, YYYY h:mma"):(t=moment.utc(t,"MMM D, YYYY h:mma"),moment(t.toDate()).format("MMM D, YYYY h:mma"))}function timediff(){time=moment.utc(time,"MMM D, YYYY h:mma");var t=moment.utc(moment().utc().format("MMM D, YYYY h:mm a"),"MMM D, YYYY h:mma"),e=moment.duration(t.diff(time)).asHours(),o=moment.duration(t.diff(time)).asMinutes(),a=moment.duration(t.diff(time)).asSeconds();return e>6?moment(time.toDate()).format("MMM D, YYYY h:mma"):e>1?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(e,10)+" hours ago":1==e?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(e,10)+" hour ago":o>1?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(o,10)+" minutes ago":1==o?moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(o,10)+" minute ago":moment(time.toDate()).format("MMM D, YYYY h:mma")+" || "+parseInt(a,10)+" seconds ago"}function Toka(){this.chata="https://toka.io:1337",this.socket,this.categoryList=[],this.chatrooms={},this.currentChatroom={},this.newMessages=0,this.sortedChatroomList=!1,this.tokabot,this.ini=function(){var t=this,e=new LeftNavApp,o=new TopNavApp;t.adjustSiteContentHeight(),$(window).off("resize").on("resize",function(){t.adjustSiteContentHeight()}),$("#search-page").off().on("click",function(){t.alert("Search is not available yet.")}),e.ini(),o.ini()},this.iniSockets=function(){var t=this;try{t.socket=io.connect(toka.chata,{secure:!0}),t.socket.on("connect",function(){console.log("Connection opened.")}),t.socket.on("disconnect",function(){console.log("Connection closed.")})}catch(e){console.log("Could not connect to chata!")}},this.adjustSiteContentHeight=function(){$("#site-content").css("min-height",$("#site").height()-$("#site-menu").height()),$("#site-left-nav").css("min-height",$("#site").height()-$("#site-menu").height())},this.getCookie=function(t){for(var e=t+"=",o=document.cookie.split(";"),a=0;a<o.length;a++){for(var s=o[a];" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(e))return s.substring(e.length,s.length)}return""},this.promptLogin=function(){$("#login-form").off().on("shown.bs.modal",function(){$("#toka-login-username").focus()}),$("#login-form").modal("show")},this.resetTitle=function(){var t=$("title");t.text("Toka")},this.setChatrooms=function(t){var e=this;for(var o in t)e.chatrooms[o]=new Chatroom(t[o])},this.setTitle=function(t){var e=$("title");e.text(t)}}function LeftNavApp(){this.ini=function(){$("#profile").on("click",function(){$("#profile-menu").hasClass("open")?($("#profile-menu").slideUp(500),$("#profile-menu").removeClass("open").addClass("closed")):($("#profile-menu").slideDown(500),$("#profile-menu").removeClass("closed").addClass("open"))}),$("#chatfeed-btn").off("click").on("click",function(){var t=$("#chatfeed iframe").attr("src");"about:blank"==t&&$("#chatfeed iframe").attr("src","/chatroom/"+toka.getCookie("username")+"?embed=1&target=_blank"),$("#chatfeed").modal("show")})}}function TopNavApp(){this.ini=function(){$("#toka-left-nav-toggle").on("click",function(){if($("#site-left-nav").hasClass("closed")){var t=Number($("#site-content").css("width").replace("px",""))-220;$("#site-left-nav").toggle("slide","left",800),$("#site-content").effect("size",{to:{"margin-left":"220px",width:t+"px"}},800),$("#site-left-nav").removeClass("closed").addClass("open")}else{var t=Number($("#site-content").css("width").replace("px",""))+220;$("#site-left-nav").toggle("slide","right",800),$("#site-content").effect("size",{to:{"margin-left":"0px",width:t+"px"}},800),$("#site-left-nav").removeClass("open").addClass("closed")}})}}function Chatroom(t){this.newMessages=0,this.lastSender="",this.autoScroll=!0;for(var e in t)this[e]=t[e];this.groupMessageFlag="n",this.commandsHelpActive=!1,this.selectChatroomItem=".chatroom-item[data-chatroom-id='"+this.chatroomId+"']",this.selectChatroomItemTopContainer=this.selectChatroomItem+" .chatroom-item-top",this.selectChatroomItemUserCount=this.selectChatroomItem+" .chatroom-item-bottom .chatroom-item-users-count",this.selectChatroom=".chatroom[data-chatroom-id='"+this.chatroomId+"']",this.selectChatroomList=this.selectChatroom+" .messages",this.selectChatroomBody=this.selectChatroom+" .messages-container",this.selectChatroomChatBox=this.selectChatroom+" .chatbox",this.selectChatroomInfoBox=this.selectChatroom+" .infobox",this.selectChatroomInputMsg=this.selectChatroom+" .inputbox .input-msg",this.selectChatroomTitleMenuUser=this.selectChatroom+" .title-menu .users",this.selectChatroomUserList=this.selectChatroom+" .user-list",this.commandHelp=new CommandHelp($(this.selectChatroomChatBox),$(this.selectChatroomInputMsg))}function Message(t,e,o,a){this.chatroomId=t,this.username=e,this.text=o,this.timestamp=a}Autocomplete.prototype.ini=function(){var t=this;t.input.on("input",function(e){var o=t.input.val(),a=o.substr(o.length-1,o.length);if("@"===a)t.active=!0;else if(t.active){-1==t.startIndex&&(t.startIndex=o.length-1);var s=o.substr(t.startIndex);t.getUsernameMatches(s)}})},Autocomplete.prototype.getUsernameMatches=function(t){var e=this;e.app=$("<div></div>",{"class":"autocomplete-username",style:"display: none;"}).append($("<div></div>",{"class":"title",html:'<span>usernames matching:</span><span class="text"></span>'})).append($("<ul></ul>",{"class":"ac-username-list"})),e.container.append(e.app);var o={};$.ajax({url:"/rs/user/search?u="+t,type:"GET",dataType:"json",beforeSend:o.hasOwnProperty("beforeSend")?o.beforeSend:function(){},complete:o.hasOwnProperty("complete")?o.complete:function(){},success:function(t){200!==t.status?console.log("Error!!"):e.app.show()}})},CommandHelp.prototype.ini=function(){var t=this;t.app=$("<div></div>",{"class":"commands-help",style:"display: none;"}).append($("<div></div>",{"class":"commands-top",html:"<span>Commands</span>"})).append($("<ul></ul>",{"class":"commands-list"})),t.container.append(t.app);for(var e in t.commands)t.commands.hasOwnProperty(e)&&t.app.find(".commands-list").append($("<li></li>",{html:'<span class="command">'+e+' </span><span class="command-options">'+t.commands[e].options+'</span><span class="command-desc">'+t.commands[e].desc+"</span>"}));t.app.find(".commands-list li:first").addClass("selected"),$("html").on("keyup",function(e){return t.active&&27==e.which?void t.hide():void 0}),t.app.find("li").on("click",function(){var e=t.app.find("li.selected");e.removeClass("selected"),$(this).addClass("selected");var o=$(this).find(".command").text();t.filterList(o),t.loadCommand($(this))}),t.input.on("input",function(e){var o=t.input.val();"/"===o?(t.app.show(),t.active=!0,$(t.input).addClass("commandActive"),$(t.app).css("bottom",$(t.input).outerHeight())):""==o&&t.hide()}),t.input.on("keyup",function(e){var o=t.input.val(),a=o.split(" ")[0];if(t.active){if(t.active&&38==e.which){var s=t.app.find("li.selected");return void(s.prev().length&&(s.removeClass("selected"),s.prev().addClass("selected")))}if(40==e.which){var s=t.app.find("li.selected");return void(s.next().length&&(s.removeClass("selected"),s.next().addClass("selected")))}if(13==e.which&&!e.shiftKey||9==e.which){var s=t.app.find("li.visible.selected"),i=s.find(".command").text();return void(i.length>=o.length?t.loadCommand(s):t.hide())}t.filterList(a);var s=t.app.find("li.visible:first").addClass("selected");0==s.length?t.autocomplete=!1:t.autocomplete=!0}})},CommandHelp.prototype.filterList=function(t){var e=this;e.app.find("li").filter(function(){$(this).show(),$(this).addClass("visible"),$(this).removeClass("selected");var e=$(this).text();e.indexOf(t)<0&&($(this).hide(),$(this).removeClass("visible"))})},CommandHelp.prototype.hide=function(){var t=this;$(t.app).hide(),t.active=!1,$(t.input).removeClass("commandActive")},CommandHelp.prototype.loadCommand=function(t){var e=this,o=t.find(".command").text();e.input.val(o),e.input.focus()},CommandHelp.prototype.sendReady=function(){var t=this;return!t.active||t.active&&!t.autocomplete};var toka={};Chatroom.prototype.iniChatroom=function(){var t=this;$(t.selectChatroomBody).height(t.getHeight()),$(window).on("resize",function(){$(t.selectChatroomBody).height(t.getHeight())}),$(window).on("focus",function(){toka.newMessages=0,toka.setTitle(t.chatroomName+" - Toka")}),$(t.selectChatroomInputMsg).off("click").on("click",function(){toka.newMessages=0,toka.setTitle(t.chatroomName+" - Toka")}),$(t.selectChatroomInputMsg).on("keydown",function(t){(9==t.which||13==t.which&&!t.shiftKey)&&t.preventDefault()}),t.commandHelp.ini(),$(t.selectChatroomInputMsg).on("keyup",function(e){if(toka.newMessages=0,toka.setTitle(t.chatroomName+" - Toka"),t.commandHelp.sendReady()&&13===e.which)if(e.shiftKey){var o=parseInt($(t.selectChatroomInputMsg).attr("rows"));4>o&&($(t.selectChatroomInputMsg).attr("rows",o+1),$(t.selectChatroomBody).height(t.getHeight()))}else t.sendMessage(),$(t.selectChatroomInputMsg).attr("rows",1),$(t.selectChatroomBody).height(t.getHeight())}),$(t.selectChatroomTitleMenuUser).off().on({mouseenter:function(){toka.socket.emit("users",toka.currentChatroom.chatroomId);var e=$(this).offset(),o=$(t.selectChatroomUserList);o.width("auto");var a=o.width();o.width(a),o.show().offset({top:e.top,left:e.left-a})},mouseleave:function(){$(t.selectChatroomUserList).hide()}}),$(t.selectChatroomBody).mCustomScrollbar({theme:"dark",alwaysShowScrollbar:1,mouseWheel:{scrollAmount:240,normalizeDelta:!0},callbacks:{whileScrolling:function(){t.autoScroll=!1,this.mcs.topPct>=99.5&&(t.autoScroll=!0)}}}),$(t.selectChatroomInfoBox).mCustomScrollbar({alwaysShowScrollbar:0,mouseWheel:{scrollAmount:120}})},Chatroom.prototype.getHeight=function(){return $("#site").height()-$("#site-menu").height()-$(".chatroom-heading").outerHeight(!0)-$(".inputbox").outerHeight()},Chatroom.prototype.loadHistory=function(t){toka.tokabot.loadHistory(t)},Chatroom.prototype.receiveMessage=function(t){var e=this;$(e.selectChatroomList),toka.getCookie("username");t.timestamp=timestamp(t.timestamp),toka.tokabot.receiveMessage(t)},Chatroom.prototype.scrollChatToBottom=function(){var t=this;$(t.selectChatroomBody).mCustomScrollbar("update"),$(t.selectChatroomBody).mCustomScrollbar("scrollTo","bottom",{scrollInertia:0})},Chatroom.prototype.sendMessage=function(){var t=this,e=toka.getCookie("username");if(""===e)return void toka.promptLogin();var o=$(t.selectChatroomInputMsg).val(),a=new Message(t.chatroomId,e,o,timestamp());""!==o.trim()&&($(t.selectChatroomInputMsg).val(""),toka.tokabot.sendMessage(a))},Chatroom.prototype.update=function(){var t=this,e=toka.getCookie("username");if(""===e)return void toka.alert("Cannot update chatroom! Please log in.");var o={};o.chatroomId=t.chatroomId,o.categoryName=t.categoryName,o.chatroomName=t.chatroomName,o.info=t.info,o.tags=t.tags;var a={beforeSend:function(){$("#update-chatroom-loader").show()},complete:function(){$("#update-chatroom-loader").hide()}};$.ajax({url:"/chatroom/"+t.chatroomId+"/update",type:"POST",data:o,dataType:"json",beforeSend:a.hasOwnProperty("beforeSend")?a.beforeSend:function(){},complete:a.hasOwnProperty("complete")?a.complete:function(){},success:function(t){if(200!==t.status){var e=t.message;e=e.charAt(0).toUpperCase()+e.slice(1),chatroomApp.alertUpdateChatroom("Server Error: "+e)}else window.location.href="/chatroom/"+t.chatroomId}})},Chatroom.prototype.updateChatroomItemUsers=function(t){var e=this;$(e.selectChatroomItemUserCount).text(t)};var banned_list={bitch:1,dick:1,fuck:1,motherfucker:1,penis:1,shit:1,vagina:1,wanker:1,god:1,jesus:1,christ:1,satan:1},reserved_list={google:1,facebook:1,linkedin:1,microsoft:1,twitter:1,support:1,tokaadmin:1,toka_admin:1,tokahelp:1,toka_help:1,tokasupport:1,toka_support:1,tokabot:1,toka_bot:1};