"use strict";function TokaBot(e){this.commandRegex=/^(\/[a-z]+)([\s]*.*)/,this.hashtagRegex=/^#([a-zA-Z0-9]+)/,this.urlRegex=/^(https?:\/\/)?([a-z0-9]+\.)+([a-z0-9]{2}).*/i,this.usernameRegex=/^@([a-zA-Z0-9_]{3,25})/,this.apiKeys={mashape:"sg6Dd6Ff8Fmshpfw0y54clebF90dp1ENrq8jsnfWhLmR7wG7eX",google:"AIzaSyAE_-wG-uRwZcLXWNwcU1B-CYLlJuVOcNc"},this.metadataCache=e.metadataCache,this.colorThemes=["FF8D36","3396FF","009688","FFB300","FF5E5E","ED72D7","A378FF","607D8B","8BC34A","1FC435","673AB7"],this.userTheme={},this.themeIndex=Math.floor(Math.random()*this.colorThemes.length);var t=new Audio("/assets/audio/chat.mp3");this.mainTheme=toka.user?toka.user.chatTheme:"normal",this.emoteSet=toka.user?toka.user.emoteSet:"standard/cat",this.options=e,this.messageAttributes,this.emotes={"o/":"toka.png","O/":"toka.png","<3":"heart.png","-_-":this.emoteSet+"/0.png",">:(":this.emoteSet+"/1.png",":3":this.emoteSet+"/2.png","8)":this.emoteSet+"/3.png","B)":this.emoteSet+"/3.png",T_T:this.emoteSet+"/4.png",">:)":this.emoteSet+"/5.png",catpa:this.emoteSet+"/6.png",catGasm:this.emoteSet+"/7.png",":P":this.emoteSet+"/8.png",":/":this.emoteSet+"/9.png",":\\":this.emoteSet+"/9.png",":)":this.emoteSet+"/10.png",":D":this.emoteSet+"/11.png",":(":this.emoteSet+"/12.png",";)":this.emoteSet+"/13.png"},this.addMessage=function(e){var t,s=this,a=$(toka.currentChatroom.selectChatroomList),i=this.getCommand(e.text);switch(i=null==i?"":i[1]){case"/me":t=this.createMeMessage(e);break;case"/image":t=this.createImageMessage(e);break;case"/spoiler":t=this.createSpoilerMessage(e);break;default:t=this.createUserMessage(e)}if(!s.messageAttributes.error){if(s.messageAttributes.contains.link)try{var o=s.messageAttributes.link;s.metadataCache.hasOwnProperty(o)?response.result.hasOwnProperty("image")&&t.find(".text").append($("<div></div>",{"class":"link embed",html:'<a href="'+o+'" target="_blank"><div class="preview"><img src="'+s.metadataCache[o].image+'" /></div><div class="desc"><b>'+s.metadataCache[o].title+"</b><br />"+s.metadataCache[o].description+"</div></a>"})):$.ajax({method:"post",url:"/api/web/meta/fetch",data:JSON.stringify({url:o}),contentType:"application/json",dataType:"json",success:function(e){200===e.status&&(s.metadataCache[o]=e.result,e.result.hasOwnProperty("image")&&t.find(".text").append($("<div></div>",{"class":"link embed",html:'<a href="'+o+'" target="_blank"><div class="preview"><img src="'+e.result.image+'" /></div><div class="desc"><b>'+e.result.title+"</b><br />"+e.result.description+"</div></a>"})),toka.currentChatroom.autoScroll&&toka.currentChatroom.scrollChatToBottom())}})}catch(r){}if(s.messageAttributes.contains.youtubeUrl)try{var n=s.messageAttributes.youtubeUrl,m=s.messageAttributes.youtubeUrl.match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/)[1];$.ajax({url:"https://www.googleapis.com/youtube/v3/videos?part=snippet&id="+m+"&key="+s.apiKeys.google,dataType:"json",success:function(e){e.items.length>0?t.find(".text").append($("<div></div>",{"class":"youtube embed",html:'<a href="'+n+'" target="_blank"><div class="preview"><img src="'+e.items[0].snippet.thumbnails["default"].url+'" /></div><div class="desc"><div class="yt-title"><img class="yt-icon" src="/assets/images/chatroom-icons/yt-logo-small.png" /><span><b>'+e.items[0].snippet.title+'</b></span></div><div class="yt-video-desc">'+e.items[0].snippet.description+"</div></div></a>"})):t.find(".text").append($("<div></div>",{"class":"youtube embed",html:'<a href="'+n+'" target="_blank"><div class="preview"><img class="yt-video-missing" src="/assets/images/chatroom-icons/yt-video-missing.png" /></div><div class="desc"><img class="yt-icon" src="/assets/images/chatroom-icons/yt-logo-small.png" /> Sorry about that.</div></a>'})),toka.currentChatroom.autoScroll&&toka.currentChatroom.scrollChatToBottom()}})}catch(r){}if(s.messageAttributes.contains.imageLink){var d,c=s.messageAttributes.imageLink.indexOf(".gifv");d=c>-1?$("<video></video>",{preload:"auto",autoplay:"autoplay",loop:"loop","class":"gifv",src:s.messageAttributes.imageLink.substr(0,s.messageAttributes.imageLink.length-4)+"webm",text:"Your browser does not support the video tag, upgrade to Firefox 3.5+, Google Chrome, or Safari."}):$("<a></a>",{href:s.messageAttributes.imageLink,"data-lightbox":s.messageAttributes.imageLink,"data-title":"Toka - "+s.messageAttributes.imageLink,html:'<img src="'+s.messageAttributes.imageLink+'" />'}),d.find("img").error(function(){d.parent().hide()}),t.find(".text").append($("<div></div>",{"class":"image embed"}).append(d))}}a.append(t)},this.commandCommands=function(e){e.text="The commands available are: \n /define [word] \n /me [text] \n /spoiler [text] \n /urban [word]\n /view [room]",this.createTokabotMessage(e)},this.commandDefine=function(e){var t=this,s=e.text.substr(7).trim();return""==s?(e.text='Command Error: "/define [word]" \nAdvice: Please provide a word for the command!',void t.createTokabotMessage(e)):void $.ajax({url:"https://montanaflynn-dictionary.p.mashape.com/define?word="+s,headers:{"X-Mashape-Key":t.apiKeys.mashape,Accept:"application/json"},success:function(a){0==a.definitions.length?e.text=s+" - No definition available:(":e.text=s+" - "+a.definitions[0].text,t.createTokabotMessage(e)}})},this.commandUrban=function(e){var t=this,s=e.text.substr(6).trim();return""==s?(e.text='Command Error: "/urban [word]" \nAdvice: Please provide a word for the command!',void t.createTokabotMessage(e)):void $.ajax({url:"https://mashape-community-urban-dictionary.p.mashape.com/define?term="+s,headers:{"X-Mashape-Key":t.apiKeys.mashape,Accept:"text/plain"},success:function(a){"no_results"==a.result_type?e.text=s+" - No definition available on urban:(":e.text=s+" - "+a.list[0].definition,t.createTokabotMessage(e)}})},this.commandView=function(e){var t=this,s=e.text.substr(5).trim().replace("#","").replace("@","");if(""==s)return e.text='Command Error: "/view [room]" \nAdvice: Please provide a room for the command!',void t.createTokabotMessage(e);if(this.options.embed)location.href=window.location.origin+"/chatroom/"+s+"?embed=1";else{var a="/chatroom/"+s+"?embed=1",i=$("#chatroom-popup iframe").attr("src");$("#chatroom-popup").modal("show"),i!=window.location.origin+a&&$("#chatroom-popup iframe").attr("src",a)}},this.createMeMessage=function(e){var t=e.text.substr(3);if(""==t.trim())return e.text='Command Error: "/me [text]" \nAdvice: Please provide text for the command!',this.createTokabotMessage(e),void(this.messageAttributes.error=!0);var s=$("<li></li>",{"class":"chatroom-message full-width"}),a=$("<div></div>",{"class":"info",html:"&nbsp;"}),i=$("<span></span>",{"class":"timestamp",text:e.timestamp});i.appendTo(a),a.appendTo(s);var o="#"+this.userTheme[e.username],r=$("<div></div>",{"class":"me",style:"border-color:"+o+"; color:"+o});return r.text(e.username+t),r.appendTo(s),s},this.createImageMessage=function(e){var t=e.text.substr(6);if(""==t.trim())return e.text='Command Error: "/image [id]" \nAdvice: Please provide an id for the command!',this.createTokabotMessage(e),void(this.messageAttributes.error=!0);var s=$("<li></li>",{"class":"chatroom-message"}),a=$("<div></div>",{"class":"info"}),i="#"+this.userTheme[e.username],o=$("<span></span>",{"class":"username",style:"color: "+i,text:e.username+" shared an image"}),r=$("<span></span>",{"class":"timestamp",text:e.timestamp});o.appendTo(a),r.appendTo(a),a.appendTo(s);var n=$("<div></div>",{"class":"image-upload"}),m=$.cloudinary.image(t.trim(),{height:150,crop:"fill",radius:5,default_image:"notfound_pmscxe.png"}),d=$.cloudinary.image(t.trim(),{default_image:"notfound_pmscxe.png",angle:"exif"}),c=$("<a></a>",{href:d.attr("src"),"data-lightbox":t.trim(),"data-title":"Toka - "+t.trim()}).on("click",function(e){e.preventDefault()});return n.append(c.append(m)),n.appendTo(s),s},this.createSpoilerMessage=function(e){var t=e.text.substr(9);if(""==t.trim())return e.text='Command Error: "/spoiler [text]" \nAdvice: Please provide text for the command!',this.createTokabotMessage(e),void(this.messageAttributes.error=!0);var s=this.createUserMessage(e,!0),a=s.find(".text"),i=$("<div></div>",{style:"cursor:pointer;","class":"spoiler",type:"button",text:"Spoiler"}).data("show",!1),o=this.parseMessage(e,t);return i.on("click",function(){$(this).data("show")||($(this).attr("style","cursor: text;"),$(this).empty().append(o),$(this).data("show",!0))}),a.text(""),a.append(i),s},this.createTokabotMessage=function(e){var t=(e.username===toka.getCookie("username"),$("<li></li>",{"class":"chatroom-message"})),s=$("<div></div>",{"class":"info"}),a=$("<span></span>",{"class":"username",text:"tokabot"}),i=$("<span></span>",{"class":"timestamp",text:e.timestamp});a.appendTo(s),i.appendTo(s),s.appendTo(t);var o=$("<div></div>",{"class":"profilePic",html:'<img src="/assets/images/icons/user.svg" />'}),r=$("<div></div>",{"class":"tokabot text"}),n=$("<div></div>",{"class":"chat"}).append(o).append(r).append($("<div></div>",{"class":"clearfix"})),m=$("<span></span>").text(e.text);r.append(m),n.appendTo(t);var d=$(toka.currentChatroom.selectChatroomList);d.append(t),toka.currentChatroom.scrollChatToBottom()},this.createUserMessage=function(e,t){var s=e.username===toka.getCookie("username"),a=$("<li></li>",{"class":"chatroom-message"}),i=$("<div></div>",{"class":"info"}),o=$("<span></span>",{"class":"username",text:e.username}),r=$("<span></span>",{"class":"timestamp",text:e.timestamp});o.appendTo(i),r.appendTo(i),i.appendTo(a);var n="#"+this.userTheme[e.username],m=$("<div></div>",{"class":"profilePic",style:"background-color: "+n,html:'<img src="/assets/images/icons/user.svg" />'}),d=$("<div></div>",{"class":s?"sender text":"other text"}),c=$("<div></div>",{"class":"chat"}).append(m).append(d).append($("<div></div>",{"class":"clearfix"}));if(!t){var p=this.parseMessage(e,e.text);d.append(p)}return c.appendTo(a),a},this.getColorTheme=function(e){return this.colorThemes[e%this.colorThemes.length]},this.getCommand=function(e){return this.commandRegex.exec(e)},this.loadHistory=function(e){for(var t=0;t<e.data.length;t++){this.messageAttributes={contains:{}};var s=e.data[t];this.registerNewUserTheme(s.username),s.timestamp=timestamp(s.timestamp),this.addMessage(s),toka.currentChatroom.lastSender=s.username}toka.currentChatroom.scrollChatToBottom()},this.isEmote=function(e){return this.emotes.hasOwnProperty(e)},this.isHashtag=function(e){return e.match(this.hashtagRegex)},this.isUrl=function(e){return e.match(this.urlRegex)},this.isUsername=function(e,t){var s=this,a=this.usernameRegex.exec(t);return a&&"send"==e.type?($.ajax({url:"/api/user/"+a[1]+"/available",type:"get",success:function(t){t.available||(e.chatroomId=a[1],toka.socket.emit("sendMessage",e),e.chatroomId==toka.getCookie("username")||s.messageAttributes.senderReceipt||(e.chatroomId=toka.getCookie("username"),toka.socket.emit("sendMessage",e),s.messageAttributes.senderReceipt=!0))}}),!0):a?!0:!1},this.parseMessage=function(e,t){for(var s=$("<div></div>"),a=t.split(/(\s+)/),i=0;i<a.length;i++){var o=a[i],r=this.parseWord(e,o);s.append(r)}return s},this.parseWord=function(e,t){$("<div></div>");if(this.isEmote(t))return $("<div>").append($("<img />",{"class":"emote",src:"/assets/images/emotes/"+this.emotes[t]})).append($("<span></span>",{text:" "})).children();if(this.isUsername(e,t)){var s=$("<div></div>"),a=this.usernameRegex.exec(t),i=t.substr(0,a[1].length+1),o=t.substr(a[1].length+1);return a[1]!=toka.getCookie("username")?s.append($("<span></span>",{style:"background-color: rgba(20, 24, 27, 0.5); color: white; border-radius: 4px; padding: 2px; font-weight: bold",text:i})).append($("<span></span>").text(o)):s.append($("<span></span>",{style:"background-color: rgba(11,15,18,0.8); color: white; border-radius: 4px; padding: 2px; font-weight: bold",text:i})).append($("<span></span>").text(o)),s.children()}if(this.isHashtag(t)){var r,n=$("<div></div>"),m=this.hashtagRegex.exec(t),d=t.substr(0,m[1].length+1),o=t.substr(m[1].length+1);return this.options.embed?(r="_blank"==this.options.target?"/chatroom/"+m[1]:"/chatroom/"+m[1]+"?embed=1",n.append($("<a></a>",{href:r,text:d,target:this.options.target})).append($("<span></span>").text(o))):(r="/chatroom/"+m[1]+"?embed=1",n.append($("<a></a>",{href:"#",text:d}).on("click",function(){$("#chatroom-popup").modal("show");var e=$("#chatroom-popup iframe").get(0).contentWindow.location.href;e!=window.location.origin+r&&$("#chatroom-popup iframe").attr("src",r)})).append($("<span></span>").text(o))),n.children()}if(this.isUrl(t)){var c=$("<div></div>"),p=this.urlRegex.exec(t),h=p[0],l=p[0],o=t.substr(h.length);return l.match(/^http(s)?:\/\//)||(l="http://"+l),c.append($("<a></a>",{href:l,text:h,target:"_blank"})).append($("<span></span>").text(o)),t.indexOf("youtube.com")>-1||t.indexOf("youtu.be")>-1?(this.messageAttributes.contains.youtubeUrl=!0,this.messageAttributes.youtubeUrl=t):/\.(gif|jpg|jpeg|tiff|png)/i.test(t)?(this.messageAttributes.contains.imageLink=!0,this.messageAttributes.imageLink=l):(this.messageAttributes.contains.link=!0,this.messageAttributes.link=l),c.children()}return $("<span></span>",{text:""==t?"":t})},this.receiveMessage=function(e){e.type="receive",this.messageAttributes={contains:{}},this.addMessage(e),this.options.focused||this.options.embed||0==this.options.settings.soundNotification?this.options.embed||1!=this.options.settings.soundNotification||t.play():t.play(),toka.currentChatroom.autoScroll&&toka.currentChatroom.scrollChatToBottom(),toka.currentChatroom.lastSender=e.username},this.registerNewUserTheme=function(e){this.userTheme.hasOwnProperty(e)||(this.userTheme[e]=toka.tokabot.getColorTheme(this.themeIndex),this.themeIndex++)},this.sendMessage=function(e){e.type="send",this.messageAttributes={contains:{},senderReceipt:!1,error:!1};var t=!1,s=this.getCommand(e.text);switch(s=null==s?"":s[1]){case"/command":this.commandCommands(e);break;case"/commands":this.commandCommands(e);break;case"/define":this.commandDefine(e);break;case"/urban":this.commandUrban(e);break;case"/view":this.commandView(e);break;default:this.addMessage(e),t=!0}t&&!this.messageAttributes.error&&(toka.socket.emit("sendMessage",e),this.messageAttributes.contains.youtubeUrl&&(e.chatroomId="youtube",toka.socket.emit("sendMessage",e)),this.messageAttributes.contains.link&&(e.chatroomId="link",toka.socket.emit("sendMessage",e))),toka.currentChatroom.scrollChatToBottom()}}