"use strict";function TokaBot(e){this.commandRegex=/^(\/[a-z]+)([\s]*.*)/;this.hashtagRegex=/^#([a-zA-Z0-9]+)/;this.urlRegex=/^(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|moe|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2}))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?/i;this.usernameRegex=/^@([a-zA-Z0-9_]{3,25})/;this.apiKeys={mashape:"sg6Dd6Ff8Fmshpfw0y54clebF90dp1ENrq8jsnfWhLmR7wG7eX",google:"AIzaSyAE_-wG-uRwZcLXWNwcU1B-CYLlJuVOcNc"};this.metadataCache=e.metadataCache;this.colorThemes=["FF8D36","FFB300","1FC435","3396FF","FF5E5E","ED72D7","A378FF","999999"];this.userTheme={};var t=new Audio("/assets/audio/chat.mp3");this.mainTheme=toka.user?toka.user.chatTheme:"normal";this.emoteSet=toka.user?toka.user.emoteSet:"standard/cat";this.options=e;this.messageAttributes;this.emotes={"o/":"toka.png","O/":"toka.png","<3":"heart.png","-_-":this.emoteSet+"/0.png",">:(":this.emoteSet+"/1.png",":3":this.emoteSet+"/2.png","8)":this.emoteSet+"/3.png","B)":this.emoteSet+"/3.png",T_T:this.emoteSet+"/4.png",">:)":this.emoteSet+"/5.png",catpa:this.emoteSet+"/6.png",catGasm:this.emoteSet+"/7.png",":P":this.emoteSet+"/8.png",":/":this.emoteSet+"/9.png",":\\":this.emoteSet+"/9.png",":)":this.emoteSet+"/10.png",":D":this.emoteSet+"/11.png",":(":this.emoteSet+"/12.png",";)":this.emoteSet+"/13.png"};this.addMessage=function(e){var t=this;var a=$(toka.currentChatroom.selectChatroomList);var s;var i=this.getCommand(e.text);i=i==null?"":i[1];switch(i){case"/me":s=this.createMeMessage(e);break;case"/image":s=this.createImageMessage(e);break;case"/spoiler":s=this.createSpoilerMessage(e);break;default:s=this.createUserMessage(e);break}if(!t.messageAttributes["error"]){if(t.messageAttributes["contains"]["link"]){try{var r=t.messageAttributes["link"];if(!t.metadataCache.hasOwnProperty(r)){$.ajax({method:"post",url:"/rs/web/meta/fetch",data:JSON.stringify({url:r}),contentType:"application/json",dataType:"json",success:function(e){t.metadataCache[r]=e.result;if(e.result.hasOwnProperty("image")){s.find(".text").append($("<div></div>",{"class":"link embed",html:'<a href="'+r+'" target="_blank"><div class="preview"><img src="'+e.result["image"]+'" /></div>'+'<div class="desc"><b>'+e.result["title"]+"</b><br />"+e.result["description"]+"</div></a>"}))}if(toka.currentChatroom.autoScroll){toka.currentChatroom.scrollChatToBottom()}}})}else{s.find(".text").append($("<div></div>",{"class":"link embed",html:'<a href="'+r+'" target="_blank"><div class="preview"><img src="'+t.metadataCache[r]["image"]+'" /></div>'+'<div class="desc"><b>'+t.metadataCache[r]["title"]+"</b><br />"+t.metadataCache[r]["description"]+"</div></a>"}))}}catch(o){}}if(t.messageAttributes["contains"]["youtubeUrl"]){try{var n=t.messageAttributes["youtubeUrl"];var m=t.messageAttributes["youtubeUrl"].match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/)[1];$.ajax({url:"https://www.googleapis.com/youtube/v3/videos?part=snippet&id="+m+"&key="+t.apiKeys["google"],dataType:"json",success:function(e){if(e.items.length>0){s.find(".text").append($("<div></div>",{"class":"youtube embed",html:'<a href="'+n+'" target="_blank"><div class="preview"><img src="'+e.items[0].snippet.thumbnails["default"].url+'" /></div>'+'<div class="desc"><div class="yt-title"><img class="yt-icon" src="/assets/images/chatroom-icons/yt-logo-small.png" /><span><b>'+e.items[0].snippet.title+"</b></span></div>"+'<div class="yt-video-desc">'+e.items[0].snippet.description+"</div></div></a>"}))}else{s.find(".text").append($("<div></div>",{"class":"youtube embed",html:'<a href="'+n+'" target="_blank"><div class="preview"><img class="yt-video-missing" src="/assets/images/chatroom-icons/yt-video-missing.png" /></div>'+'<div class="desc"><img class="yt-icon" src="/assets/images/chatroom-icons/yt-logo-small.png" /> Sorry about that.</div></a>'}))}if(toka.currentChatroom.autoScroll){toka.currentChatroom.scrollChatToBottom()}}})}catch(o){}}if(t.messageAttributes["contains"]["imageLink"]){var c=$("<a></a>",{href:t.messageAttributes["imageLink"],"data-lightbox":t.messageAttributes["imageLink"],"data-title":"Toka - "+t.messageAttributes["imageLink"],html:'<img src="'+t.messageAttributes["imageLink"]+'" />'});s.find(".text").append($("<div></div>",{"class":"image embed"}).append(c))}}a.append(s)};this.commandCommands=function(e){e.text="The commands available are: "+"\n /define [word] "+"\n /me [text] "+"\n /spoiler [text] "+"\n /urban [word]"+"\n /view [room]";this.createTokabotMessage(e)};this.commandDefine=function(e){var t=this;var a=e.text.substr(7).trim();if(a==""){e.text='Command Error: "/define [word]" \nAdvice: Please provide a word for the command!';t.createTokabotMessage(e);return}$.ajax({url:"https://montanaflynn-dictionary.p.mashape.com/define?word="+a,headers:{"X-Mashape-Key":t.apiKeys["mashape"],Accept:"application/json"},success:function(s){if(s.definitions.length==0)e.text=a+" - "+"No definition available :(";else e.text=a+" - "+s.definitions[0].text;t.createTokabotMessage(e)}})};this.commandUrban=function(e){var t=this;var a=e.text.substr(6).trim();if(a==""){e.text='Command Error: "/urban [word]" \nAdvice: Please provide a word for the command!';t.createTokabotMessage(e);return}$.ajax({url:"https://mashape-community-urban-dictionary.p.mashape.com/define?term="+a,headers:{"X-Mashape-Key":t.apiKeys["mashape"],Accept:"text/plain"},success:function(s){if(s.result_type=="no_results")e.text=a+" - No definition available on urban :(";else e.text=a+" - "+s.list[0].definition;t.createTokabotMessage(e)}})};this.commandView=function(e){var t=this;var a=e.text.substr(5).trim();if(a==""){e.text='Command Error: "/view [room]" \nAdvice: Please provide a room for the command!';t.createTokabotMessage(e);return}if(this.options.embed){location.href=window.location.origin+"/chatroom/"+a+"?embed=1"}else{var s="/chatroom/"+a+"?embed=1";$("#chatroom-popup").modal("show");var i=$("#chatroom-popup iframe").get(0).contentWindow.location.href;if(i!=window.location.origin+s)$("#chatroom-popup iframe").attr("src",s)}};this.createMeMessage=function(e){var t=e.text.substr(3);if(t.trim()==""){e.text='Command Error: "/me [text]" \nAdvice: Please provide text for the command!';this.createTokabotMessage(e);this.messageAttributes["error"]=true;return}var a=$("<li></li>",{"class":"chatroom-message full-width"});var s=$("<div></div>",{"class":"info",html:"&nbsp;"});var i=$("<span></span>",{"class":"timestamp",text:e.timestamp});i.appendTo(s);s.appendTo(a);var r=$("<div></div>",{"class":"me"});r.text(e.username+t);r.appendTo(a);return a};this.createImageMessage=function(e){var t=e.text.substr(6);if(t.trim()==""){e.text='Command Error: "/image [id]" \nAdvice: Please provide an id for the command!';this.createTokabotMessage(e);this.messageAttributes["error"]=true;return}var a=$("<li></li>",{"class":"chatroom-message"});var s=$("<div></div>",{"class":"info"});var i=$("<span></span>",{"class":"username",text:e.username});var r=$("<span></span>",{"class":"timestamp",text:e.timestamp});i.appendTo(s);r.appendTo(s);s.appendTo(a);var o=$("<div></div>",{"class":"image-upload"});var n=$.cloudinary.image(t.trim(),{height:150,crop:"fill",radius:5,default_image:"notfound_pmscxe.png"});var m=$.cloudinary.image(t.trim(),{default_image:"notfound_pmscxe.png",angle:"exif"});var c=$("<a></a>",{href:m.attr("src"),"data-lightbox":t.trim(),"data-title":"Toka - "+t.trim()}).on("click",function(e){e.preventDefault()});o.append(c.append(n));o.appendTo(a);return a};this.createSpoilerMessage=function(e){var t=e.text.substr(9);if(t.trim()==""){e.text='Command Error: "/spoiler [text]" \nAdvice: Please provide text for the command!';this.createTokabotMessage(e);this.messageAttributes["error"]=true;return}var a=this.createUserMessage(e,true);var s=a.children(".text");var i=$("<div></div>",{style:"cursor:pointer;","class":"spoiler",type:"button",text:"Spoiler"}).data("show",false);var r=this.parseMessage(e,t);i.on("click",function(){if(!$(this).data("show")){$(this).attr("style","cursor: text;");$(this).empty().append(r);$(this).data("show",true)}});s.text("");s.append(i);return a};this.createTokabotMessage=function(e){var t=e.username===toka.getCookie("username");var a=$("<li></li>",{"class":"chatroom-message"});var s=$("<div></div>",{"class":"info"});var i=$("<span></span>",{"class":"username",text:"tokabot"});var r=$("<span></span>",{"class":"timestamp",text:e.timestamp});i.appendTo(s);r.appendTo(s);s.appendTo(a);var o=$("<div></div>",{"class":"tokabot text"});var n=$("<span></span>").text(e.text);o.append(n);o.appendTo(a);var m=$(toka.currentChatroom.selectChatroomList);m.append(a);toka.currentChatroom.scrollChatToBottom()};this.createUserMessage=function(e,t){var a=e.username===toka.getCookie("username");var s=$("<li></li>",{"class":"chatroom-message"});var i=$("<div></div>",{"class":"info"});var r=$("<span></span>",{"class":"username",text:e.username});var o=$("<span></span>",{"class":"timestamp",text:e.timestamp});r.appendTo(i);o.appendTo(i);i.appendTo(s);var n=$("<div></div>",{"class":"profilePic",style:"background-color: #"+this.userTheme[e.username],html:'<img src="/assets/images/icons/user.svg" />'});var m=$("<div></div>",{"class":a?"sender text":"other text"});var c=$("<div></div>",{"class":"chat"}).append(n).append(m).append($("<div></div>",{"class":"clearfix"}));if(!t){var d=this.parseMessage(e,e.text);m.append(d)}c.appendTo(s);return s};this.getColorTheme=function(e){return this.colorThemes[e%this.colorThemes.length]};this.getCommand=function(e){return this.commandRegex.exec(e)};this.loadHistory=function(e){for(var t=0;t<e.data.length;t++){this.messageAttributes={contains:{}};var a=e.data[t];this.registerNewUserTheme(a.username,t);a.timestamp=timestamp(a.timestamp);this.addMessage(a);toka.currentChatroom.lastSender=a.username}toka.currentChatroom.scrollChatToBottom()};this.isEmote=function(e){return this.emotes.hasOwnProperty(e)};this.isHashtag=function(e){return e.match(this.hashtagRegex)};this.isUrl=function(e){return e.match(this.urlRegex)};this.isUsername=function(e,t){var a=this;var s=this.usernameRegex.exec(t);if(s&&e.type=="send"){$.ajax({url:"/rs/user/"+s[1]+"/available",type:"get",success:function(t){if(!t.available){e.chatroomId=s[1];toka.socket.emit("sendMessage",e);if(e.chatroomId!=toka.getCookie("username")&&!a.messageAttributes["senderReceipt"]){e.chatroomId=toka.getCookie("username");toka.socket.emit("sendMessage",e);a.messageAttributes["senderReceipt"]=true}}}});return true}else if(s){return true}else{return false}};this.parseMessage=function(e,t){var a=$("<div></div>");var s=t.split(/(\s+)/);for(var i=0;i<s.length;i++){var r=s[i];var o=this.parseWord(e,r);a.append(o)}return a};this.parseWord=function(e,t){var a=this;var s=$("<div></div>");if(this.isEmote(t)){return $("<div>").append($("<img />",{"class":"emote",src:"/assets/images/emotes/"+this.emotes[t]})).append($("<span></span>",{text:" "})).children()}else if(this.isUsername(e,t)){var i=$("<div></div>");var r=this.usernameRegex.exec(t);var o=t.substr(0,r[1].length+1);var n=t.substr(r[1].length+1);if(r[1]!=toka.getCookie("username"))i.append($("<span></span>",{style:"background-color: rgba(20, 24, 27, 0.5); color: white; border-radius: 4px; padding: 2px; font-weight: bold",text:o})).append($("<span></span>").text(n));else i.append($("<span></span>",{style:"background-color: rgba(11,15,18,0.8); color: white; border-radius: 4px; padding: 2px; font-weight: bold",text:o})).append($("<span></span>").text(n));return i.children()}else if(this.isHashtag(t)){var m;var c=$("<div></div>");var d=this.hashtagRegex.exec(t);var h=t.substr(0,d[1].length+1);var n=t.substr(d[1].length+1);if(this.options.embed){m=this.options.target=="_blank"?"/chatroom/"+d[1]:"/chatroom/"+d[1]+"?embed=1";c.append($("<a></a>",{href:m,text:h,target:this.options.target})).append($("<span></span>").text(n))}else{m="/chatroom/"+d[1]+"?embed=1";c.append($("<a></a>",{href:"#",text:h}).on("click",function(){$("#chatroom-popup").modal("show");var e=$("#chatroom-popup iframe").get(0).contentWindow.location.href;if(e!=window.location.origin+m)$("#chatroom-popup iframe").attr("src",m)})).append($("<span></span>").text(n))}return c.children()}else if(this.isUrl(t)){var p=$("<div></div>");var l=this.urlRegex.exec(t);var u=l[0];var g=l[0];var n=t.substr(u.length);if(!g.match(/^http(s)?:\/\//)){g="http://"+g}p.append($("<a></a>",{href:g,text:u,target:"_blank"})).append($("<span></span>").text(n));if(t.indexOf("youtube.com")>-1||t.indexOf("youtu.be")>-1){this.messageAttributes["contains"]["youtubeUrl"]=true;this.messageAttributes["youtubeUrl"]=t}else if(/\.(gif|jpg|jpeg|tiff|png)/i.test(t)){this.messageAttributes["contains"]["imageLink"]=true;this.messageAttributes["imageLink"]=g}else{this.messageAttributes["contains"]["link"]=true;this.messageAttributes["link"]=g}return p.children()}else{return $("<span></span>",{text:t==""?"":t})}};this.receiveMessage=function(e){e["type"]="receive";this.messageAttributes={contains:{}};this.addMessage(e);if(!this.options["focused"]&&!this.options.embed&&this.options.settings["soundNotification"]!=0){t.play()}else if(!this.options.embed&&this.options.settings["soundNotification"]==1){t.play()}if(toka.currentChatroom.autoScroll){toka.currentChatroom.scrollChatToBottom()}toka.currentChatroom.lastSender=e.username};this.registerNewUserTheme=function(e,t){if(!this.userTheme.hasOwnProperty(e))this.userTheme[e]=toka.tokabot.getColorTheme(t)};this.sendMessage=function(e){e["type"]="send";this.messageAttributes={contains:{},senderReceipt:false,error:false};var t=false;var a=this.getCommand(e.text);a=a==null?"":a[1];switch(a){case"/command":this.commandCommands(e);break;case"/commands":this.commandCommands(e);break;case"/define":this.commandDefine(e);break;case"/urban":this.commandUrban(e);break;case"/view":this.commandView(e);break;default:this.addMessage(e);t=true;break}if(t&&!this.messageAttributes["error"]){toka.socket.emit("sendMessage",e);if(this.messageAttributes["contains"]["youtubeUrl"]){e.chatroomId="youtube";toka.socket.emit("sendMessage",e)}if(this.messageAttributes["contains"]["link"]){e.chatroomId="link";toka.socket.emit("sendMessage",e)}}toka.currentChatroom.scrollChatToBottom()}}