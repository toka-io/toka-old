"use strict";function TokaBot(e){this.commandRegex=/^(\/[a-z]+)([\s]*.*)/;this.hashtagRegex=/^#([a-zA-Z0-9]+)/;this.urlRegex=/^(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|moe|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2}))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?/i;this.usernameRegex=/^@([a-zA-Z0-9_]{3,25})/;this.apiKeys={mashape:"sg6Dd6Ff8Fmshpfw0y54clebF90dp1ENrq8jsnfWhLmR7wG7eX",google:"AIzaSyAE_-wG-uRwZcLXWNwcU1B-CYLlJuVOcNc"};var t=new Audio("/assets/audio/chat.mp3");this.mainTheme=toka.user?toka.user.chatTheme:"normal";this.emoteSet=toka.user?toka.user.emoteSet:"standard/cat";this.options=e;this.messageAttributes;this.emotes={"o/":"toka.png","O/":"toka.png","<3":"heart.png","-_-":this.emoteSet+"/0.png",">:(":this.emoteSet+"/1.png",":3":this.emoteSet+"/2.png","8)":this.emoteSet+"/3.png","B)":this.emoteSet+"/3.png",T_T:this.emoteSet+"/4.png",">:)":this.emoteSet+"/5.png",catpa:this.emoteSet+"/6.png",catGasm:this.emoteSet+"/7.png",":P":this.emoteSet+"/8.png",":/":this.emoteSet+"/9.png",":\\":this.emoteSet+"/9.png",":)":this.emoteSet+"/10.png",":D":this.emoteSet+"/11.png",":(":this.emoteSet+"/12.png",";)":this.emoteSet+"/13.png"};this.addMessage=function(e){var t=this;var a=$(toka.currentChatroom.selectChatroomList);var s;var r=this.getCommand(e.text);r=r==null?"":r[1];switch(r){case"/me":s=this.createMeMessage(e);break;case"/image":s=this.createImageMessage(e);break;case"/spoiler":s=this.createSpoilerMessage(e);break;default:s=this.createUserMessage(e);break}if(!t.messageAttributes["error"]){if(t.messageAttributes["contains"]["youtubeUrl"]){try{var o=t.messageAttributes["youtubeUrl"];var i=t.messageAttributes["youtubeUrl"].match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/)[1];$.ajax({url:"https://www.googleapis.com/youtube/v3/videos?part=snippet&id="+i+"&key="+t.apiKeys["google"],dataType:"json",success:function(e){if(e.items.length>0){s.find(".text").append($("<div></div>",{"class":"youtube-embed",html:'<div class="yt-title"><img src="https://developers.google.com/youtube/images/YouTube-icon-full_color.png" /> <a href="'+o+'" target="_blank">'+e.items[0].snippet.title+"</a></div>"+'<div class="yt-desc">'+e.items[0].snippet.description+"</div>"+'<a href="'+o+'" target="_blank"><img src="'+e.items[0].snippet.thumbnails["default"].url+'" /></a>'}))}else{s.find(".text").append($("<div></div>",{"class":"youtube-embed",html:'<div class="yt-title"><img src="https://developers.google.com/youtube/images/YouTube-icon-full_color.png" /> <a href="'+o+'" target="_blank">The video is unavailable.</a></div>'+'<div class="yt-desc">Sorry about that.</div>'+'<a href="'+o+'" target="_blank"><img class="yt-video-missing" src="/assets/images/chatroom-icons/yt-video-missing.png" /></a>'}))}if(toka.currentChatroom.autoScroll){toka.currentChatroom.scrollChatToBottom()}}})}catch(n){}}}a.append(s)};this.commandCommands=function(e){e.text="The commands available are: "+"\n /define [word] "+"\n /me [text] "+"\n /spoiler [text] "+"\n /urban [word]"+"\n /view [room]";this.createTokabotMessage(e)};this.commandDefine=function(e){var t=this;var a=e.text.substr(7).trim();if(a==""){e.text='Command Error: "/define [word]" \nAdvice: Please provide a word for the command!';t.createTokabotMessage(e);return}$.ajax({url:"https://montanaflynn-dictionary.p.mashape.com/define?word="+a,headers:{"X-Mashape-Key":t.apiKeys["mashape"],Accept:"application/json"},success:function(s){if(s.definitions.length==0)e.text=a+" - "+"No definition available :(";else e.text=a+" - "+s.definitions[0].text;t.createTokabotMessage(e)}})};this.commandUrban=function(e){var t=this;var a=e.text.substr(6).trim();if(a==""){e.text='Command Error: "/urban [word]" \nAdvice: Please provide a word for the command!';t.createTokabotMessage(e);return}$.ajax({url:"https://mashape-community-urban-dictionary.p.mashape.com/define?term="+a,headers:{"X-Mashape-Key":t.apiKeys["mashape"],Accept:"text/plain"},success:function(s){if(s.result_type=="no_results")e.text=a+" - No definition available on urban :(";else e.text=a+" - "+s.list[0].definition;t.createTokabotMessage(e)}})};this.commandView=function(e){var t=this;var a=e.text.substr(5).trim();if(a==""){e.text='Command Error: "/view [room]" \nAdvice: Please provide a room for the command!';t.createTokabotMessage(e);return}if(this.options.embed){location.href=window.location.origin+"/chatroom/"+a+"?embed=1"}else{var s="/chatroom/"+a+"?embed=1";$("#chatroom-popup").modal("show");var r=$("#chatroom-popup iframe").get(0).contentWindow.location.href;if(r!=window.location.origin+s)$("#chatroom-popup iframe").attr("src",s)}};this.createMeMessage=function(e){var t=e.text.substr(3);if(t.trim()==""){e.text='Command Error: "/me [text]" \nAdvice: Please provide text for the command!';this.createTokabotMessage(e);this.messageAttributes["error"]=true;return}var a=$("<li></li>",{"class":"chatroom-message full-width"});var s=$("<div></div>",{"class":"info",html:"&nbsp;"});var r=$("<span></span>",{"class":"timestamp",text:e.timestamp});r.appendTo(s);s.appendTo(a);var o=$("<div></div>",{"class":"me"});o.text(e.username+t);o.appendTo(a);return a};this.createImageMessage=function(e){var t=e.text.substr(6);if(t.trim()==""){e.text='Command Error: "/image [id]" \nAdvice: Please provide an id for the command!';this.createTokabotMessage(e);this.messageAttributes["error"]=true;return}var a=$("<li></li>",{"class":"chatroom-message"});var s=$("<div></div>",{"class":"info"});var r=$("<span></span>",{"class":"username",text:e.username});var o=$("<span></span>",{"class":"timestamp",text:e.timestamp});r.appendTo(s);o.appendTo(s);s.appendTo(a);var i=$("<div></div>",{"class":"image text"});var n=$.cloudinary.image(t.trim(),{height:150,crop:"fill",radius:5,default_image:"notfound_pmscxe.png"});var m=$.cloudinary.image(t.trim(),{default_image:"notfound_pmscxe.png",angle:"exif"});var c=$("<a></a>",{href:m.attr("src"),"data-lightbox":t.trim(),"data-title":"Toka - "+t.trim()}).on("click",function(e){e.preventDefault()});i.append(c.append(n));i.appendTo(a);return a};this.createSpoilerMessage=function(e){var t=e.text.substr(9);if(t.trim()==""){e.text='Command Error: "/spoiler [text]" \nAdvice: Please provide text for the command!';this.createTokabotMessage(e);this.messageAttributes["error"]=true;return}var a=this.createUserMessage(e,true);var s=a.children(".text");var r=$("<div></div>",{style:"cursor:pointer;","class":"spoiler",type:"button",text:"Spoiler"}).data("show",false);var o=this.parseMessage(e,t);r.on("click",function(){if(!$(this).data("show")){$(this).attr("style","cursor: text;");$(this).empty().append(o);$(this).data("show",true)}});s.text("");s.append(r);return a};this.createTokabotMessage=function(e){var t=e.username===toka.getCookie("username");var a=$("<li></li>",{"class":"chatroom-message"});var s=$("<div></div>",{"class":"info"});var r=$("<span></span>",{"class":"username",text:"tokabot"});var o=$("<span></span>",{"class":"timestamp",text:e.timestamp});r.appendTo(s);o.appendTo(s);s.appendTo(a);var i=$("<div></div>",{"class":"tokabot text"});var n=$("<span></span>").text(e.text);i.append(n);i.appendTo(a);var m=$(toka.currentChatroom.selectChatroomList);m.append(a);toka.currentChatroom.scrollChatToBottom()};this.createUserMessage=function(e,t){var a=e.username===toka.getCookie("username");var s=$("<li></li>",{"class":"chatroom-message"});var r=$("<div></div>",{"class":"info"});var o=$("<span></span>",{"class":"username",text:e.username});var i=$("<span></span>",{"class":"timestamp",text:e.timestamp});o.appendTo(r);i.appendTo(r);r.appendTo(s);var n=$("<div></div>",{"class":a?"sender text":"other text"});if(!t){var m=this.parseMessage(e,e.text);n.append(m)}n.appendTo(s);return s};this.getCommand=function(e){return this.commandRegex.exec(e)};this.loadHistory=function(e){for(var t=0;t<e.data.length;t++){this.messageAttributes={contains:{}};var a=e.data[t];a.timestamp=timestamp(a.timestamp);this.addMessage(a);toka.currentChatroom.lastSender=a.username}toka.currentChatroom.scrollChatToBottom()};this.isEmote=function(e){return this.emotes.hasOwnProperty(e)};this.isHashtag=function(e){return e.match(this.hashtagRegex)};this.isUrl=function(e){return e.match(this.urlRegex)};this.isUsername=function(e,t){var a=this;var s=this.usernameRegex.exec(t);if(s&&e.type=="send"){$.ajax({url:"/rs/user/"+s[1]+"/available",type:"get",success:function(t){if(!t.available){e.chatroomId=s[1];toka.socket.emit("sendMessage",e);if(e.chatroomId!=toka.getCookie("username")&&!a.messageAttributes["senderReceipt"]){e.chatroomId=toka.getCookie("username");toka.socket.emit("sendMessage",e);a.messageAttributes["senderReceipt"]=true}}}});return true}else if(s){return true}else{return false}};this.parseMessage=function(e,t){var a=$("<div></div>");var s=t.split(/(\s+)/);for(var r=0;r<s.length;r++){var o=s[r];var i=this.parseWord(e,o);a.append(i)}return a};this.parseWord=function(e,t){var a=this;var s=$("<div></div>");if(this.isEmote(t)){return $("<div>").append($("<img />",{"class":"emote",src:"/assets/images/emotes/"+this.emotes[t]})).append($("<span></span>",{text:" "})).children()}else if(this.isUsername(e,t)){var r=$("<div></div>");var o=this.usernameRegex.exec(t);var i=t.substr(0,o[1].length+1);var n=t.substr(o[1].length+1);if(o[1]!=toka.getCookie("username"))r.append($("<span></span>",{style:"background-color: rgba(20, 24, 27, 0.5); color: white; border-radius: 4px; padding: 2px; font-weight: bold",text:i})).append($("<span></span>").text(n));else r.append($("<span></span>",{style:"background-color: rgba(11,15,18,0.8); color: white; border-radius: 4px; padding: 2px; font-weight: bold",text:i})).append($("<span></span>").text(n));return r.children()}else if(this.isHashtag(t)){var m;var c=$("<div></div>");var p=this.hashtagRegex.exec(t);var d=t.substr(0,p[1].length+1);var n=t.substr(p[1].length+1);if(this.options.embed){m=this.options.target=="_blank"?"/chatroom/"+p[1]:"/chatroom/"+p[1]+"?embed=1";c.append($("<a></a>",{href:m,text:d,target:this.options.target})).append($("<span></span>").text(n))}else{m="/chatroom/"+p[1]+"?embed=1";c.append($("<a></a>",{href:"#",text:d}).on("click",function(){$("#chatroom-popup").modal("show");var e=$("#chatroom-popup iframe").get(0).contentWindow.location.href;if(e!=window.location.origin+m)$("#chatroom-popup iframe").attr("src",m)})).append($("<span></span>").text(n))}return c.children()}else if(this.isUrl(t)){this.messageAttributes["contains"]["link"]=true;var h=$("<div></div>");var u=this.urlRegex.exec(t);var l=u[0];var g=u[0];var n=t.substr(l.length);if(!g.match(/^http(s)?:\/\//)){g="http://"+g;a.requestMeta({url:g})}h.append($("<a></a>",{href:g,text:l,target:"_blank"})).append($("<span></span>").text(n));if(t.indexOf("youtube.com")>-1||t.indexOf("youtu.be")>-1){this.messageAttributes["contains"]["youtubeUrl"]=true;this.messageAttributes["youtubeUrl"]=t}return h.children()}else{return $("<span></span>",{text:t==""?"":t})}};this.receiveMessage=function(e){e["type"]="receive";this.messageAttributes={contains:{}};this.addMessage(e);if(!this.options["focused"]&&!this.options.embed&&this.options.settings["soundNotification"]!=0){t.play()}else if(!this.options.embed&&this.options.settings["soundNotification"]==1){t.play()}if(toka.currentChatroom.autoScroll){toka.currentChatroom.scrollChatToBottom()}toka.currentChatroom.lastSender=e.username};this.sendMessage=function(e){e["type"]="send";this.messageAttributes={contains:{},senderReceipt:false,error:false};var t=false;var a=this.getCommand(e.text);a=a==null?"":a[1];switch(a){case"/command":this.commandCommands(e);break;case"/commands":this.commandCommands(e);break;case"/define":this.commandDefine(e);break;case"/urban":this.commandUrban(e);break;case"/view":this.commandView(e);break;default:this.addMessage(e);t=true;break}if(t&&!this.messageAttributes["error"]){toka.socket.emit("sendMessage",e);if(this.messageAttributes["contains"]["youtubeUrl"]){e.chatroomId="youtube";toka.socket.emit("sendMessage",e)}if(this.messageAttributes["contains"]["link"]){e.chatroomId="link";toka.socket.emit("sendMessage",e)}}toka.currentChatroom.scrollChatToBottom()};this.requestMeta=function(e,t){var a=this;if(typeof t==="undefined")t={};$.ajax({url:"/rs/web/meta/fetch",type:"POST",data:JSON.stringify(e),dataType:"json",contentType:"application/json; charset=utf-8",timeout:8e3,beforeSend:t.hasOwnProperty("beforeSend")?t["beforeSend"]:function(){},complete:t.hasOwnProperty("complete")?t["complete"]:function(){},success:function(t){a.responseHandler(e,t)},error:function(t,s,r){a.errorHandler(s,r,e)}})};this.responseHandler=function(e,t){var a=this;if(t.result){console.log(t.result)}};this.errorHandler=function(e,t,a){var s=this;console.log(e+" -- "+t)}}